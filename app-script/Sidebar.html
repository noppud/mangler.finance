<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <style>
      /* --- Reset & Base --- */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f1f3f4; /* Light gray background */
        color: #202124;
      }

      /* --- Layout --- */
      .copilot-container {
        display: flex;
        flex-direction: column;
        /* --- UPDATED: This is the fix --- */
        height: 100%; /* Was 100vh, which caused the cutoff */
        box-sizing: border-box;
        background: #ffffff; /* Clean white container */
      }

      /* --- Top bar --- */
      .top-bar {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding: 8px 12px;
        border-bottom: 1px solid #e8eaed;
      }

      .menu-wrapper {
        position: relative;
      }

      .menu-button {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .menu-button:hover {
        background: rgba(60, 64, 67, 0.08);
      }

      .menu-dots {
        font-size: 18px;
        line-height: 1;
        color: #5f6368;
      }

      .menu-dropdown {
        position: absolute;
        right: 0;
        top: 32px;
        min-width: 140px;
        background: #ffffff;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(60, 64, 67, 0.15);
        border: 1px solid rgba(60, 64, 67, 0.1);
        padding: 4px 0;
        z-index: 10;
        display: none;
      }

      .menu-dropdown.menu-open {
        display: block;
      }

      .menu-item {
        width: 100%;
        padding: 8px 16px;
        border: none;
        background: transparent;
        text-align: left;
        font-size: 13px;
        color: #202124;
        cursor: pointer;
      }

      .menu-item:hover {
        background: rgba(60, 64, 67, 0.08);
      }

      /* --- Chat Window --- */
      .chat-window {
        flex: 1;
        overflow-y: auto;
        padding: 20px 16px;
        background: #ffffff;
      }

      /* --- Custom Scrollbar --- */
      .chat-window::-webkit-scrollbar {
        width: 6px;
      }
      .chat-window::-webkit-scrollbar-track {
        background: transparent;
        margin: 4px 0;
      }
      .chat-window::-webkit-scrollbar-thumb {
        background: #dadce0;
        border-radius: 3px;
      }
      .chat-window::-webkit-scrollbar-thumb:hover {
        background: #bdc1c6;
      }

      .chat-row {
        display: flex;
        margin-bottom: 12px;
      }

      .chat-row--user {
        justify-content: flex-end;
      }

      .chat-row--bot,
      .chat-row--issue {
        justify-content: flex-start;
      }

      .chat-bubble {
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 10px;
        font-size: 13.5px;
        line-height: 1.5;
        word-wrap: break-word;
        white-space: pre-wrap;
      }

      /* Lighter user bubble */
      .chat-bubble--user {
        background: #e6f4ea; /* Light green */
        color: #0d8143; /* Dark green text */
        border-bottom-right-radius: 2px;
      }

      /* Cleaner bot bubble */
      .chat-bubble--bot {
        background: #f1f3f4; /* Light gray */
        color: #202124;
        border: none;
        border-bottom-left-radius: 2px;
      }

      /* --- AI Typing Indicator --- */
      .chat-bubble--typing {
        padding: 14px 16px; /* A bit more padding for the dots */
      }

      .typing-dots {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .typing-dots span {
        width: 8px;
        height: 8px;
        background-color: #9aa0a6;
        border-radius: 50%;
        animation: typing-jump 1.2s infinite ease-in-out;
      }

      .typing-dots span:nth-child(1) {
        animation-delay: 0s;
      }
      .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing-jump {
        0%,
        80%,
        100% {
          transform: translateY(0);
          opacity: 0.4;
        }
        40% {
          transform: translateY(-4px);
          opacity: 1;
        }
      }

      /* --- Sleek Input Area --- */
      .input-row {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        padding: 12px 16px;
        background: #ffffff;
        border-top: 1px solid #e8eaed;
      }

      .input-row textarea {
        flex: 1;
        resize: none; /* No resize handle */
        min-height: 42px; /* Match button height */
        max-height: 140px;
        padding: 10px 14px;
        border-radius: 8px;
        border: 1px solid #dadce0;
        background: #ffffff;
        color: #202124;
        font-size: 14px;
        font-family: inherit;
        box-sizing: border-box;
        transition: all 0.2s ease;
        line-height: 1.5;
      }

      .input-row textarea::placeholder {
        color: #9aa0a6;
      }

      .input-row textarea:focus {
        outline: none;
        border-color: #0f9d58;
        box-shadow: 0 0 0 2px rgba(15, 157, 88, 0.1);
      }

      /* Icon Button */
      .input-row button {
        border: none;
        border-radius: 8px;
        padding: 0;
        font-size: 14px;
        cursor: pointer;
        background: transparent;
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 42px;
        height: 42px;
        flex-shrink: 0;
        transition: all 0.2s ease;
      }

      .input-row button svg {
        width: 20px;
        height: 20px;
        /* Disabled color set in JS */
        transition: fill 0.2s ease;
      }

      .input-row button:hover:not(:disabled) {
        background: #f1f3f4;
      }

      .input-row button:disabled {
        cursor: default;
      }

      /* --- Issue Cards (Sleek update) --- */
      .issue-card {
        width: 100%;
        box-sizing: border-box;
        padding: 12px 14px;
        border-radius: 8px;
        background: #ffffff;
        border: 1px solid #e8eaed;
        border-left: 3px solid;
        font-size: 12px;
        color: #202124;
        box-shadow: 0 1px 2px rgba(60, 64, 67, 0.08);
        transition: all 0.2s ease;
      }

      .issue-card:hover {
        box-shadow: 0 2px 4px rgba(60, 64, 67, 0.12);
      }

      .issue-card--resolved {
        opacity: 0.6;
        background: #f8f9fa;
        border-style: dashed;
      }

      .issue-meta-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }

      .issue-pill {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 10px;
        background: #f1f3f4;
        color: #5f6368;
        font-weight: 500;
        white-space: nowrap;
        letter-spacing: 0.2px;
      }

      .issue-severity-badge {
        font-size: 9px;
        padding: 2px 7px;
        border-radius: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        white-space: nowrap;
      }

      .issue-severity-critical {
        background: #fce8e6;
        color: #c5221f;
      }
      .issue-severity-high {
        background: #fef7e0;
        color: #ea8600;
      }
      .issue-severity-medium {
        background: #fff4e5;
        color: #f9ab00;
      }
      .issue-severity-low {
        background: #e8f0fe;
        color: #1967d2;
      }

      .issue-title {
        font-size: 13px;
        font-weight: 500;
        color: #202124;
        line-height: 1.5;
        margin-bottom: 10px;
      }

      .issue-description-container {
        display: none;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #f1f3f4;
      }

      .issue-description-container.expanded {
        display: block;
      }

      .issue-description-full {
        color: #5f6368;
        line-height: 1.6;
        font-size: 11px;
        margin-bottom: 12px;
      }

      .issue-read-more {
        margin-top: 8px;
        background: none;
        border: none;
        color: #1a73e8;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        padding: 0;
        text-align: left;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: color 0.2s ease;
      }
      .issue-read-more:hover {
        color: #1557b0;
      }
      .issue-read-more-icon {
        font-size: 9px;
        transition: transform 0.25s ease;
        display: inline-block;
      }
      .issue-read-more.expanded .issue-read-more-icon {
        transform: rotate(180deg);
      }

      .issue-suggested-fix {
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 2px solid #0f9d58;
      }
      .issue-suggested-fix-label {
        font-size: 9px;
        font-weight: 600;
        color: #0f9d58;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
      }
      .issue-suggested-fix-text {
        font-size: 11px;
        color: #5f6368;
        line-height: 1.5;
      }

      .issue-actions {
        display: flex;
        gap: 6px;
        margin-top: 12px;
        padding-top: 10px;
        border-top: 1px solid #f1f3f4;
      }

      /* Modern buttons */
      .issue-btn {
        flex: 1;
        padding: 7px 12px;
        font-size: 11.5px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        white-space: nowrap;
        font-weight: 600;
        transition: all 0.2s ease;
      }

      .issue-btn-fix {
        background: #0d8143; /* Darker, more "pro" green */
        color: #ffffff;
      }
      .issue-btn-fix:hover:not(:disabled) {
        background: #0a6b3a;
      }

      .issue-btn-ignore {
        background: #f1f3f4;
        color: #5f6368;
        border: none;
      }
      .issue-btn-ignore:hover:not(:disabled) {
        background: #e8eaed;
      }

      .issue-btn-undo {
        background: #fef7e0;
        color: #ea8600;
        border: none;
      }
      .issue-btn-undo:hover:not(:disabled) {
        background: #fdeec9;
      }

      .issue-btn:disabled {
        opacity: 0.5;
        cursor: default;
      }

      .issue-status {
        font-size: 10px;
        color: #9aa0a6;
        margin-top: 8px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="copilot-container">
      <div class="top-bar">
        <div class="menu-wrapper">
          <button
            type="button"
            class="menu-button"
            id="menu-button"
            aria-label="More options"
          >
            <span class="menu-dots">⋮</span>
          </button>
          <div class="menu-dropdown" id="options-menu">
            <button type="button" class="menu-item" data-action="clear-chat">
              Clear chat
            </button>
            <button type="button" class="menu-item" data-action="quit">
              Quit
            </button>
          </div>
        </div>
      </div>

      <div id="chat" class="chat-window"></div>

      <form id="chat-form" class="input-row">
        <textarea
          id="user-input"
          rows="1"
          placeholder="Ask about this sheet, formulas, or issues…"
        ></textarea>
        <button id="send-btn" type="submit" title="Send message">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            width="20"
            height="20"
          >
            <path
              d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"
              fill="#9aa0a6"
            ></path>
          </svg>
        </button>
      </form>
    </div>

    <script>
      (function () {
        const chatEl = document.getElementById("chat");
        const formEl = document.getElementById("chat-form");
        const inputEl = document.getElementById("user-input");
        const sendBtnEl = document.getElementById("send-btn");
        const sendBtnSvg = sendBtnEl.querySelector("svg path");
        const menuButtonEl = document.getElementById("menu-button");
        const optionsMenuEl = document.getElementById("options-menu");

        const SVG_COLOR_DISABLED = "#9aa0a6";
        const SVG_COLOR_ENABLED = "#0f9d58";
        const TYPING_INDICATOR_ID = "typing-indicator";

        document.addEventListener("DOMContentLoaded", function () {
          loadSpreadsheetInfo();
          setInitialButtonState();
          // Ensure the input is visible on load by setting initial height
          autoGrow(inputEl);
        });

        function setInitialButtonState() {
          sendBtnEl.disabled = true;
          if (sendBtnSvg) sendBtnSvg.setAttribute("fill", SVG_COLOR_DISABLED);
        }

        /* --- Auto-resize textarea --- */
        function autoGrow(element) {
          // Set to a small height to correctly calculate scrollHeight
          element.style.height = "auto";
          element.style.height = element.scrollHeight + "px";
        }
        inputEl.addEventListener("input", () => autoGrow(inputEl));

        /* --- Load initial info --- */
        function loadSpreadsheetInfo() {
          google.script.run
            .withSuccessHandler(function (info) {
              addGreeting(info);
              scrollToBottom();
            })
            .withFailureHandler(function (err) {
              addGreeting({
                url: "Unable to get spreadsheet URL",
                name: "Unknown",
              });
              scrollToBottom();
            })
            .getSpreadsheetInfo();
        }

        function addGreeting(spreadsheetInfo) {
          const row = document.createElement("div");
          row.className = "chat-row chat-row--bot";

          const bubble = document.createElement("div");
          bubble.className = "chat-bubble chat-bubble--bot";

          // Create message parts
          var parts = [
            document.createTextNode("Hi, I'm your spreadSheet Mangler.\n\n"),
          ];
          // Closing message
          parts.push(
            document.createTextNode(
              "Tell me what you're up to, and I'll help you in any way."
            )
          );

          // Append all parts
          parts.forEach(function (part) {
            bubble.appendChild(part);
          });

          row.appendChild(bubble);
          chatEl.appendChild(row);
        }

        /* --- Options menu --- */
        menuButtonEl.addEventListener("click", function (e) {
          e.stopPropagation();
          optionsMenuEl.classList.toggle("menu-open");
        });

        document.addEventListener("click", function () {
          optionsMenuEl.classList.remove("menu-open");
        });

        optionsMenuEl.addEventListener("click", function (e) {
          const action =
            e.target && e.target.dataset ? e.target.dataset.action : null;
          if (!action) return;

          e.stopPropagation();
          optionsMenuEl.classList.remove("menu-open");

          if (action === "clear-chat") {
            chatEl.innerHTML = "";
            addBotMessage("Chat cleared.");
            scrollToBottom();
          }

          if (action === "quit") {
            if (
              google &&
              google.script &&
              google.script.host &&
              google.script.host.close
            ) {
              google.script.host.close();
            }
          }
        });

        /* --- Handle Enter-to-Send --- */
        inputEl.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault(); // Prevent newline
            // Trigger form submit if not empty
            if (inputEl.value.trim().length > 0) {
              formEl.dispatchEvent(new Event("submit", { cancelable: true }));
            }
          }
        });

        /* --- Handle dynamic send button state --- */
        inputEl.addEventListener("input", function () {
          // Only update if the input is not *already* disabled
          if (!inputEl.disabled) {
            if (inputEl.value.trim().length > 0) {
              sendBtnEl.disabled = false;
              if (sendBtnSvg)
                sendBtnSvg.setAttribute("fill", SVG_COLOR_ENABLED);
            } else {
              sendBtnEl.disabled = true;
              if (sendBtnSvg)
                sendBtnSvg.setAttribute("fill", SVG_COLOR_DISABLED);
            }
          }
          autoGrow(inputEl); // Also grow on input
        });

        /* --- Chat submit --- */
        formEl.addEventListener("submit", function (e) {
          e.preventDefault();
          const text = (inputEl.value || "").trim();
          if (!text) return;

          addUserMessage(text);
          inputEl.value = "";
          autoGrow(inputEl); // Reset height after send
          disableInput(true);
          // --- NEW: Add typing indicator ---
          addTypingIndicator();
          scrollToBottom();

          google.script.run
            .withSuccessHandler(function (response) {
              // --- NEW: Remove typing indicator ---
              removeTypingIndicator();

              if (response && response.reply) {
                addBotMessage(response.reply);
              }

              if (
                response &&
                response.issues &&
                response.issues.potential_errors &&
                response.issues.potential_errors.length
              ) {
                addIssueCards(response.issues.potential_errors);
              }

              disableInput(false);
              scrollToBottom();
            })
            .withFailureHandler(function (err) {
              // --- NEW: Remove typing indicator ---
              removeTypingIndicator();

              addBotMessage(
                "Oops, something went wrong: " +
                  (err && err.message ? err.message : err)
              );
              disableInput(false);
              scrollToBottom();
            })
            .handleUserMessage(text);
        });

        /* --- Issue button handling --- */
        chatEl.addEventListener("click", function (e) {
          const target = e.target;
          const button = target.closest(".issue-btn, .issue-btn-undo");

          if (!button) return; // Not a button click

          if (button.classList.contains("issue-btn-undo")) {
            handleUndoButton(button);
          } else if (button.classList.contains("issue-btn")) {
            handleIssueButton(button);
          }
        });

        function handleIssueButton(button) {
          const card = button.closest(".issue-card");
          if (!card || card.classList.contains("issue-card--resolved")) return;

          const action = button.dataset.action;
          const cellLocation = card.dataset.cellLocation;
          const issueData = card.dataset.issueData
            ? JSON.parse(card.dataset.issueData)
            : null;
          const buttons = card.querySelectorAll(".issue-btn");
          const statusEl = card.querySelector(".issue-status");
          const actionsEl = card.querySelector(".issue-actions");

          buttons.forEach(function (btn) {
            btn.disabled = true;
          });
          statusEl.textContent =
            action === "fix" ? "Applying AI fix…" : "Ignoring…";

          if (action === "fix") {
            // Call AI to fix the issue
            google.script.run
              .withSuccessHandler(function (result) {
                if (result && result.success) {
                  card.classList.add("issue-card--resolved");
                  statusEl.textContent = result.message || "Fixed with AI";

                  // Add undo button
                  actionsEl.innerHTML =
                    '<button type"button" class="issue-btn issue-btn-undo" data-action="undo">' +
                    "Undo Fix</button>";
                } else {
                  buttons.forEach(function (btn) {
                    btn.disabled = false;
                  });
                  statusEl.textContent =
                    result.message || "AI couldn't fix this issue";
                }
              })
              .withFailureHandler(function (err) {
                buttons.forEach(function (btn) {
                  btn.disabled = false;
                });
                statusEl.textContent =
                  "Error: " +
                  (err && err.message ? err.message : "Failed to fix");
              })
              .fixIssueWithAI(issueData);
          } else if (action === "ignore") {
            // Just revert colors
            google.script.run
              .withSuccessHandler(function (result) {
                card.classList.add("issue-card--resolved");
                statusEl.textContent = "Ignored";
              })
              .withFailureHandler(function (err) {
                buttons.forEach(function (btn) {
                  btn.disabled = false;
                });
                statusEl.textContent =
                  "Error: " +
                  (err && err.message ? err.message : "Failed to ignore");
              })
              .ignoreIssue(cellLocation);
          }
        }

        function handleUndoButton(button) {
          const card = button.closest(".issue-card");
          if (!card) return;

          const cellLocation = card.dataset.cellLocation;
          const statusEl = card.querySelector(".issue-status");

          button.disabled = true;
          statusEl.textContent = "Undoing…";

          google.script.run
            .withSuccessHandler(function (result) {
              if (result && result.success) {
                card.classList.remove("issue-card--resolved");
                statusEl.textContent = "Fix undone";

                // Restore original buttons
                const actionsEl = card.querySelector(".issue-actions");
                actionsEl.innerHTML =
                  '<button type="button" class="issue-btn issue-btn-fix" data-action="fix">Fix with AI</button>' +
                  '<button type="button" class="issue-btn issue-btn-ignore" data-action="ignore">Ignore</button>';
              } else {
                button.disabled = false;
                statusEl.textContent =
                  "Undo failed: " + (result.error || "Unknown error");
              }
            })
            .withFailureHandler(function (err) {
              button.disabled = false;
              statusEl.textContent =
                "Undo error: " +
                (err && err.message ? err.message : "Unknown error");
            })
            .undoAIFix(cellLocation);
        }

        /* --- Chat rendering helpers --- */

        function addUserMessage(text) {
          const row = document.createElement("div");
          row.className = "chat-row chat-row--user";

          const bubble = document.createElement("div");
          bubble.className = "chat-bubble chat-bubble--user";
          bubble.innerHTML = escapeHtml(text);

          row.appendChild(bubble);
          chatEl.appendChild(row);
        }

        function addBotMessage(text) {
          const row = document.createElement("div");
          row.className = "chat-row chat-row--bot";

          const bubble = document.createElement("div");
          bubble.className = "chat-bubble chat-bubble--bot";
          bubble.innerHTML = escapeHtml(text);

          row.appendChild(bubble);
          chatEl.appendChild(row);
        }

        // --- NEW: Typing Indicator Functions ---
        function addTypingIndicator() {
          // Don't add if one is already showing
          if (document.getElementById(TYPING_INDICATOR_ID)) return;

          const row = document.createElement("div");
          row.className = "chat-row chat-row--bot";
          row.id = TYPING_INDICATOR_ID;

          const bubble = document.createElement("div");
          bubble.className = "chat-bubble chat-bubble--bot chat-bubble--typing";

          bubble.innerHTML =
            '<div class="typing-dots">' +
            "<span></span><span></span><span></span>" +
            "</div>";

          row.appendChild(bubble);
          chatEl.appendChild(row);
        }

        function removeTypingIndicator() {
          const indicator = document.getElementById(TYPING_INDICATOR_ID);
          if (indicator) {
            indicator.remove();
          }
        }
        // --- End of new functions ---

        function addIssueCards(issues) {
          issues.forEach(function (issue, index) {
            const row = document.createElement("div");
            row.className = "chat-row chat-row--issue";

            const card = document.createElement("div");
            card.className = "issue-card";
            card.dataset.cellLocation =
              issue.cell_location || issue.range?.a1Notation || "";

            // Store full issue data for AI fix
            card.dataset.issueData = JSON.stringify({
              cell_location:
                issue.cell_location || issue.range?.a1Notation || "",
              title: issue.title || issue.message || "Issue",
              description: issue.description || "",
              severity: issue.severity || "medium",
              category: issue.category || "",
              suggestedFix: issue.suggestedFix || "",
            });

            const safeTitle = escapeHtml(
              issue.title || issue.message || "Issue"
            );
            const safeDescription = escapeHtml(issue.description || "");
            const safeLocation = escapeHtml(
              issue.cell_location || issue.range?.a1Notation || ""
            );
            const safeCategory = escapeHtml(issue.category || "");
            const safeSeverity = (issue.severity || "medium").toLowerCase();
            const safeSuggestedFix = escapeHtml(issue.suggestedFix || "");
            const color = issue.color || "#f97316";

            // Generate unique ID for this issue card
            const cardId =
              issue.issue_id || "issue-" + Date.now() + "-" + index;

            // Set border color based on issue color
            card.style.borderLeftColor = color;

            // Build severity badge class
            const severityClass = "issue-severity-" + safeSeverity;

            // Only show read more if there's a description (different from title) or suggested fix
            const hasDescription =
              safeDescription &&
              safeDescription.trim().length > 0 &&
              safeDescription !== safeTitle;
            const hasContentToShow = hasDescription || safeSuggestedFix;

            card.innerHTML =
              '<div class="issue-meta-row">' +
              '<span class="issue-pill">' +
              safeLocation +
              "</span>" +
              '<span class="issue-severity-badge ' +
              severityClass +
              '">' +
              safeSeverity +
              "</span>" +
              "</div>" +
              '<div class="issue-title">' +
              safeTitle +
              "</div>" +
              (hasContentToShow
                ? '<button type="button" class="issue-read-more" data-card-id="' +
                  cardId +
                  '">' +
                  "<span>Show details</span>" +
                  '<span class="issue-read-more-icon">▼</span>' +
                  "</button>" +
                  '<div class="issue-description-container" id="desc-container-' +
                  cardId +
                  '">' +
                  (hasDescription
                    ? '<div class="issue-description-full">' +
                      safeDescription +
                      "</div>"
                    : "") +
                  (safeSuggestedFix
                    ? '<div class="issue-suggested-fix">' +
                      '<div class="issue-suggested-fix-label">Suggested Fix</div>' +
                      '<div class="issue-suggested-fix-text">' +
                      safeSuggestedFix +
                      "</div>" +
                      "</div>"
                    : "") +
                  "</div>"
                : "") +
              '<div class="issue-actions">' +
              '<button type="button" class="issue-btn issue-btn-fix" data-action="fix">Fix with AI</button>' +
              '<button type="button" class="issue-btn issue-btn-ignore" data-action="ignore">Ignore</button>' +
              "</div>" +
              '<div class="issue-status">Pending</div>';

            row.appendChild(card);
            chatEl.appendChild(row);
          });

          // Add event listeners for "read more" buttons
          chatEl.querySelectorAll(".issue-read-more").forEach(function (btn) {
            btn.addEventListener("click", function () {
              const cardId = btn.dataset.cardId;
              const descContainer = document.getElementById(
                "desc-container-" + cardId
              );
              if (descContainer) {
                const isExpanded = descContainer.classList.contains("expanded");
                if (isExpanded) {
                  descContainer.classList.remove("expanded");
                  btn.classList.remove("expanded");
                  btn.querySelector("span:first-child").textContent =
                    "Show details";
                } else {
                  descContainer.classList.add("expanded");
                  btn.classList.add("expanded");
                  btn.querySelector("span:first-child").textContent =
                    "Hide details";
                }
              }
            });
          });
        }

        function scrollToBottom() {
          chatEl.scrollTop = chatEl.scrollHeight;
        }

        function disableInput(disabled) {
          inputEl.disabled = disabled;
          sendBtnEl.disabled = disabled;

          if (disabled) {
            // Always show disabled gray when bot is thinking
            if (sendBtnSvg) sendBtnSvg.setAttribute("fill", SVG_COLOR_DISABLED);
          } else {
            // When re-enabling, check if there's text
            if (inputEl.value.trim().length > 0) {
              sendBtnEl.disabled = false;
              if (sendBtnSvg)
                sendBtnSvg.setAttribute("fill", SVG_COLOR_ENABLED);
            } else {
              sendBtnEl.disabled = true;
              if (sendBtnSvg)
                sendBtnSvg.setAttribute("fill", SVG_COLOR_DISABLED);
            }
            inputEl.focus(); // Focus input when bot is done
          }
        }

        function escapeHtml(str) {
          const div = document.createElement("div");
          div.appendChild(document.createTextNode(String(str)));
          return div.innerHTML;
        }
      })();
    </script>
  </body>
</html>
